<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <title>Multi-Model AI Chat (Puter.js)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#2563eb" />

  <style>
    :root {
      --bg: #f3f4f6;
      --bg-soft: #e5e7eb;
      --bg-card: #ffffff;
      --text: #111827;
      --text-muted: #6b7280;
      --primary: #2563eb;
      --primary-soft: #dbeafe;
      --border: #e5e7eb;
      --danger: #b91c1c;
    }

    body[data-theme="dark"] {
      --bg: #020617;
      --bg-soft: #0f172a;
      --bg-card: #020617;
      --text: #e5e7eb;
      --text-muted: #9ca3af;
      --primary: #3b82f6;
      --primary-soft: rgba(37,99,235,.1);
      --border: #1f2937;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: var(--bg);
      color: var(--text);
      height: 100vh;          /* kunci tinggi viewport */
      min-height: 100vh;
      display: flex;
      justify-content: center;
      padding: 16px;
      transition: background .2s ease, color .2s ease;
      overflow: hidden;       /* supaya yang scroll cuma box chat */
    }

    .app {
      width: 100%;
      max-width: 1100px;
      background: var(--bg-card);
      border-radius: 20px;
      box-shadow:
        0 10px 25px rgba(15,23,42,0.18),
        0 0 0 1px var(--border);
      display: flex;
      flex-direction: row;
      overflow: hidden;
      height: 100%;          /* isi penuh tinggi body */
      max-height: 100%;
    }

    @media (max-width: 840px) {
      body {
        padding: 8px;
      }
      .app {
        flex-direction: column;
        height: 100%;
      }
    }

    .sidebar {
      width: 320px;
      max-width: 100%;
      padding: 16px 14px;
      border-right: 1px solid var(--border);
      background: var(--bg-soft);
      overflow-y: auto;       /* sidebar juga bisa scroll kalau konten kepanjangan */
    }

    @media (max-width: 840px) {
      .sidebar {
        width: 100%;
        border-right: none;
        border-bottom: 1px solid var(--border);
      }
    }

    .main {
      flex: 1;
      display: flex;
      flex-direction: column;
      min-height: 0;          /* penting supaya flex child bisa scroll */
    }

    .header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px 14px;
      border-bottom: 1px solid var(--border);
      flex-shrink: 0;
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .logo-circle {
      width: 32px;
      height: 32px;
      border-radius: 999px;
      background: linear-gradient(135deg, #2563eb, #4f46e5);
      display: flex;
      align-items: center;
      justify-content: center;
      color: #fff;
      font-weight: 700;
      font-size: 18px;
    }

    .logo-text { display: flex; flex-direction: column; }

    .logo-text strong { font-size: 14px; }

    .logo-text span {
      font-size: 11px;
      color: var(--text-muted);
    }

    .theme-toggle {
      border: none;
      background: transparent;
      width: 32px;
      height: 32px;
      border-radius: 999px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 18px;
    }

    .section-title {
      font-size: 12px;
      font-weight: 700;
      margin: 6px 0 2px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .section-title span {
      font-size: 11px;
      font-weight: 400;
      color: var(--text-muted);
    }

    label {
      font-size: 12px;
      font-weight: 600;
      margin-top: 8px;
      display: block;
    }

    select,
    textarea {
      width: 100%;
      padding: 7px 9px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: var(--bg-card);
      color: var(--text);
      font-size: 13px;
      outline: none;
    }

    select:focus,
    textarea:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 1px var(--primary-soft);
    }

    textarea {
      resize: vertical;
      min-height: 70px;
    }

    .small {
      font-size: 11px;
      color: var(--text-muted);
      margin-top: 2px;
    }

    .slider-row {
      display: flex;
      align-items: center;
      gap: 6px;
      margin-top: 6px;
    }

    input[type="range"] {
      flex: 1;
    }

    .chips {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      font-size: 11px;
    }

    .chip {
      padding: 3px 7px;
      border-radius: 999px;
      border: 1px solid var(--border);
      cursor: pointer;
      color: var(--text-muted);
    }

    .chip.active {
      border-color: var(--primary);
      color: var(--primary);
      background: var(--primary-soft);
    }

    .chat {
      flex: 1;
      display: flex;
      flex-direction: column;
      min-height: 0;        /* penting supaya messages bisa overflow */
    }

    .messages {
      flex: 1;
      padding: 12px 14px;
      overflow-y: auto;     /* ini yang bikin jadi scroll box */
      scroll-behavior: smooth;
      min-height: 0;
    }

    .message {
      max-width: 80%;
      padding: 9px 11px;
      border-radius: 14px;
      margin-bottom: 8px;
      font-size: 13px;
      line-height: 1.45;
      white-space: pre-wrap;
      word-wrap: break-word;
    }

    .message.user {
      margin-left: auto;
      background: var(--primary);
      color: #fff;
      border-bottom-right-radius: 4px;
    }

    .message.assistant {
      margin-right: auto;
      background: var(--bg-soft);
      border-bottom-left-radius: 4px;
    }

    .message.system {
      margin: 0 auto 8px;
      background: transparent;
      border-radius: 0;
      padding: 3px 6px;
      font-size: 11px;
      color: var(--text-muted);
    }

    .bubble-meta {
      display: block;
      font-size: 10px;
      opacity: 0.8;
      margin-bottom: 2px;
    }

    .input-area {
      border-top: 1px solid var(--border);
      padding: 8px 10px;
      display: flex;
      flex-direction: column;
      gap: 6px;
      flex-shrink: 0;      /* biar tinggi input tidak kepotong ketika viewport kecil */
    }

    .chat-header-settings {
      font-size: 11px;
      color: var(--text-muted);
      margin-top: 4px;
    }

    .input-row-main {
      display: flex;
      gap: 8px;
    }

    .input-row-main textarea {
      flex: 1;
      min-height: 50px;
      max-height: 140px;
    }

    .btn-send {
      border-radius: 999px;
      border: none;
      padding: 8px 12px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      background: linear-gradient(135deg, var(--primary), #4f46e5);
      color: #fff;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      white-space: nowrap;
    }

    .btn-send:disabled {
      opacity: 0.6;
      cursor: default;
    }

    .toast {
      position: fixed;
      left: 50%;
      bottom: 18px;
      transform: translateX(-50%) translateY(10px);
      background: #111827;
      color: #f9fafb;
      padding: 7px 11px;
      border-radius: 999px;
      font-size: 11px;
      display: flex;
      align-items: center;
      gap: 8px;
      box-shadow: 0 10px 25px rgba(15,23,42,.5);
      opacity: 0;
      pointer-events: none;
      transition: opacity .15s ease, transform .15s ease;
      z-index: 9999;
    }

    .toast.show {
      opacity: 1;
      transform: translateX(-50%) translateY(0);
      pointer-events: auto;
    }

    .toast-error {
      border: 1px solid #ef4444;
    }

    .toast-success {
      border: 1px solid #22c55e;
    }

    code {
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 12px;
      background: rgba(148,163,184,0.2);
      padding: 1px 3px;
      border-radius: 4px;
    }
  </style>
</head>
<body data-theme="light">
  <div class="app">
    <!-- SIDEBAR -->
    <aside class="sidebar">
      <div class="section-title">
        <span>Pengaturan</span>
        <span id="sessionInfo"></span>
      </div>

      <label for="modelSelect">Model (Puter.js)</label>
      <select id="modelSelect">
        <!-- GPT 5.x -->
        <option value="gpt-5.1">gpt-5.1</option>
        <option value="gpt-5.1-codex">gpt-5.1-codex</option>
        <option value="gpt-5.1-codex-mini">gpt-5.1-codex-mini</option>
        <option value="gpt-5.1-chat-latest">gpt-5.1-chat-latest</option>
        <option value="gpt-5">gpt-5</option>
        <option value="gpt-5-mini">gpt-5-mini</option>
        <option value="gpt-5-nano" selected>gpt-5-nano</option>
        <option value="gpt-5-chat-latest">gpt-5-chat-latest</option>
        <!-- GPT 4.x -->
        <option value="gpt-4.1">gpt-4.1</option>
        <option value="gpt-4.1-mini">gpt-4.1-mini</option>
        <option value="gpt-4.1-nano">gpt-4.1-nano</option>
        <option value="gpt-4.5-preview">gpt-4.5-preview</option>
        <option value="gpt-4o">gpt-4o</option>
        <option value="gpt-4o-mini">gpt-4o-mini</option>
        <!-- o-series -->
        <option value="o1">o1</option>
        <option value="o1-mini">o1-mini</option>
        <option value="o1-pro">o1-pro</option>
        <option value="o3">o3</option>
        <option value="o3-mini">o3-mini</option>
        <option value="o4-mini">o4-mini</option>
        <!-- Claude -->
        <option value="claude-sonnet-4">claude-sonnet-4</option>
        <option value="claude-sonnet-4-5">claude-sonnet-4-5</option>
        <option value="claude-opus-4">claude-opus-4</option>
        <option value="claude-opus-4-1">claude-opus-4-1</option>
        <option value="claude-opus-4-5">claude-opus-4-5</option>
        <option value="claude-haiku-4-5">claude-haiku-4-5</option>
      </select>
      <div class="small">
        Model disediakan oleh <b>Puter.js</b> ‚Äì tanpa API key & tanpa backend.
      </div>

      <div class="slider-row">
        <span style="font-size:11px;">Temperature</span>
        <input type="range" id="temperature" min="0" max="2" step="0.1" value="1" />
        <span id="tempLabel" style="font-size:11px;width:28px;text-align:right;">1.0</span>
      </div>
      <div class="small">Semakin tinggi ‚Üí jawaban lebih kreatif / acak.</div>

      <label for="systemPrompt">System prompt (opsional)</label>
      <textarea id="systemPrompt" placeholder="Contoh: Kamu adalah asisten yang menjawab dalam bahasa Indonesia."></textarea>

      <div class="section-title" style="margin-top:10px;">
        <span>Sesi & History</span>
      </div>
      <div class="chips">
        <div class="chip active" id="chipModeChat">Chat</div>
        <div class="chip" id="chipModeReset">Reset percakapan</div>
        <div class="chip" id="chipClearStorage">Hapus data lokal</div>
      </div>
      <div class="small" style="margin-top:6px;">
        Riwayat & pengaturan disimpan di <code>localStorage</code> browser kamu.
      </div>
    </aside>

    <!-- MAIN -->
    <main class="main">
      <header class="header">
        <div class="logo">
          <div class="logo-circle">AI</div>
          <div class="logo-text">
            <strong>Multi-Model Chat</strong>
            <span>Puter.js ¬∑ siap GitHub Pages</span>
          </div>
        </div>
        <button class="theme-toggle" id="themeToggle" title="Dark / Light mode">
          <span id="themeIcon">üåô</span>
        </button>
      </header>

      <div class="chat">
        <div id="messages" class="messages"></div>

        <div class="input-area">
          <div class="chat-header-settings" id="modelMeta">
            Model: <code>gpt-5-nano</code> ¬∑ Temp: <span id="metaTemp">1.0</span>
          </div>
          <div class="input-row-main">
            <textarea id="userInput" placeholder="Ketik pesan di sini, lalu tekan Enter (atau tombol Kirim)."></textarea>
            <button class="btn-send" id="sendBtn" type="button">
              <span id="sendLabel">Kirim</span>
              <span id="sendSpinner" style="display:none;">‚è≥</span>
            </button>
          </div>
          <div class="small">
            Tips: tekan <b>Shift+Enter</b> untuk baris baru. Enter untuk kirim.
          </div>
        </div>
      </div>
    </main>
  </div>

  <!-- TOAST -->
  <div class="toast" id="toast">
    <span id="toastIcon">‚úÖ</span>
    <span id="toastText">Pesan</span>
  </div>

  <!-- Puter.js -->
  <script src="https://js.puter.com/v2/"></script>

  <script>
    // ======== KONFIG LOCAL STORAGE KEYS ========
    const STORAGE_KEYS = {
      THEME: "mmchat-theme",
      SETTINGS: "mmchat-settings",
      HISTORY: "mmchat-history"
    };

    // ======== TOAST ========
    const toastEl = document.getElementById("toast");
    const toastText = document.getElementById("toastText");
    const toastIcon = document.getElementById("toastIcon");

    function showToast(msg, type = "success", ms = 2200) {
      toastText.textContent = msg;
      if (type === "error") {
        toastIcon.textContent = "‚ö†Ô∏è";
        toastEl.classList.add("toast-error");
        toastEl.classList.remove("toast-success");
      } else {
        toastIcon.textContent = "‚úÖ";
        toastEl.classList.add("toast-success");
        toastEl.classList.remove("toast-error");
      }
      toastEl.classList.add("show");
      setTimeout(() => toastEl.classList.remove("show"), ms);
    }

    // ======== THEME (DARK/LIGHT) ========
    const body = document.body;
    const themeToggle = document.getElementById("themeToggle");
    const themeIcon = document.getElementById("themeIcon");

    function applyTheme(theme) {
      const t = theme === "dark" ? "dark" : "light";
      body.setAttribute("data-theme", t);
      themeIcon.textContent = t === "dark" ? "‚òÄÔ∏è" : "üåô";
      const meta = document.querySelector('meta[name="theme-color"]');
      if (meta) meta.setAttribute("content", t === "dark" ? "#020617" : "#2563eb");
    }

    (function initTheme() {
      const saved = localStorage.getItem(STORAGE_KEYS.THEME);
      if (saved === "light" || saved === "dark") {
        applyTheme(saved);
      } else {
        const prefersDark = window.matchMedia &&
          window.matchMedia("(prefers-color-scheme: dark)").matches;
        applyTheme(prefersDark ? "dark" : "light");
      }
    })();

    themeToggle.addEventListener("click", () => {
      const cur = body.getAttribute("data-theme") || "light";
      const next = cur === "light" ? "dark" : "light";
      applyTheme(next);
      localStorage.setItem(STORAGE_KEYS.THEME, next);
    });

    // ======== ELEMENTS ========
    const modelSelect = document.getElementById("modelSelect");
    const temperatureInput = document.getElementById("temperature");
    const tempLabel = document.getElementById("tempLabel");
    const systemPromptInput = document.getElementById("systemPrompt");
    const chipModeChat = document.getElementById("chipModeChat");
    const chipModeReset = document.getElementById("chipModeReset");
    const chipClearStorage = document.getElementById("chipClearStorage");
    const messagesEl = document.getElementById("messages");
    const userInput = document.getElementById("userInput");
    const sendBtn = document.getElementById("sendBtn");
    const sendLabel = document.getElementById("sendLabel");
    const sendSpinner = document.getElementById("sendSpinner");
    const modelMeta = document.getElementById("modelMeta");
    const metaTemp = document.getElementById("metaTemp");
    const sessionInfo = document.getElementById("sessionInfo");

    // ======== STATE ========
    let chatHistory = []; // {role: "user"|"assistant", content:string, ts:number}
    let isSending = false;

    const defaultSettings = {
      model: "gpt-5-nano",
      temperature: 1,
      systemPrompt: ""
    };

    function loadSettings() {
      try {
        const raw = localStorage.getItem(STORAGE_KEYS.SETTINGS);
        if (!raw) return { ...defaultSettings };
        const parsed = JSON.parse(raw);
        return { ...defaultSettings, ...parsed };
      } catch {
        return { ...defaultSettings };
      }
    }

    function saveSettings(settings) {
      localStorage.setItem(STORAGE_KEYS.SETTINGS, JSON.stringify(settings));
    }

    function loadHistory() {
      try {
        const raw = localStorage.getItem(STORAGE_KEYS.HISTORY);
        if (!raw) return [];
        return JSON.parse(raw);
      } catch {
        return [];
      }
    }

    function saveHistory() {
      localStorage.setItem(STORAGE_KEYS.HISTORY, JSON.stringify(chatHistory));
    }

    function resetHistory() {
      chatHistory = [];
      saveHistory();
      renderMessages();
    }

    // ======== INIT SETTINGS & HISTORY ========
    (function initSettingsAndHistory() {
      const s = loadSettings();
      if (s.model) modelSelect.value = s.model;
      temperatureInput.value = s.temperature;
      tempLabel.textContent = s.temperature.toFixed(1);
      metaTemp.textContent = s.temperature.toFixed(1);
      systemPromptInput.value = s.systemPrompt || "";
      chatHistory = loadHistory();
      renderMessages();
      updateModelMeta();
      updateSessionInfo();
    })();

    // ======== HELPERS ========
    function updateModelMeta() {
      modelMeta.innerHTML = `Model: <code>${modelSelect.value}</code> ¬∑ Temp: <span id="metaTemp">${Number(temperatureInput.value).toFixed(1)}</span>`;
    }

    function updateSessionInfo() {
      const count = chatHistory.filter(m => m.role === "user").length;
      sessionInfo.textContent = count ? `${count} pesan` : "baru";
    }

    function addMessage(role, content) {
      chatHistory.push({ role, content, ts: Date.now() });
      saveHistory();
      renderMessages();
    }

    function renderMessages() {
      messagesEl.innerHTML = "";
      if (systemPromptInput.value.trim()) {
        const sysDiv = document.createElement("div");
        sysDiv.className = "message system";
        sysDiv.textContent = `System prompt aktif: ${systemPromptInput.value.trim()}`;
        messagesEl.appendChild(sysDiv);
      }

      chatHistory.forEach(msg => {
        const div = document.createElement("div");
        div.className = "message " + msg.role;
        if (msg.role === "assistant" || msg.role === "user") {
          const meta = document.createElement("span");
          meta.className = "bubble-meta";
          meta.textContent = msg.role === "user" ? "Kamu" : "Asisten";
          div.appendChild(meta);
        }
        const textNode = document.createElement("div");
        textNode.textContent = msg.content;
        div.appendChild(textNode);
        messagesEl.appendChild(div);
      });

      messagesEl.scrollTop = messagesEl.scrollHeight;
      updateSessionInfo();
    }

    function setSendingState(sending) {
      isSending = sending;
      sendBtn.disabled = sending;
      sendLabel.style.display = sending ? "none" : "inline";
      sendSpinner.style.display = sending ? "inline" : "none";
    }

    // ======== TEMPERATURE SLIDER ========
    temperatureInput.addEventListener("input", () => {
      const t = Number(temperatureInput.value);
      tempLabel.textContent = t.toFixed(1);
      metaTemp.textContent = t.toFixed(1);
      const s = loadSettings();
      s.temperature = t;
      saveSettings(s);
      updateModelMeta();
    });

    // ======== MODEL SELECT ========
    modelSelect.addEventListener("change", () => {
      const s = loadSettings();
      s.model = modelSelect.value;
      saveSettings(s);
      updateModelMeta();
      showToast("Model diganti ke " + modelSelect.value);
    });

    // ======== SYSTEM PROMPT ========
    systemPromptInput.addEventListener("change", () => {
      const s = loadSettings();
      s.systemPrompt = systemPromptInput.value;
      saveSettings(s);
      renderMessages();
    });

    // ======== MODE CHIPS ========
    chipModeChat.addEventListener("click", () => {
      chipModeChat.classList.add("active");
      chipModeReset.classList.remove("active");
      chipClearStorage.classList.remove("active");
      showToast("Mode chat.");
    });

    chipModeReset.addEventListener("click", () => {
      if (!confirm("Reset percakapan sekarang?")) return;
      resetHistory();
      chipModeReset.classList.add("active");
      chipModeChat.classList.remove("active");
      chipClearStorage.classList.remove("active");
      setTimeout(() => {
        chipModeChat.classList.add("active");
        chipModeReset.classList.remove("active");
      }, 800);
      showToast("Percakapan direset.");
    });

    chipClearStorage.addEventListener("click", () => {
      if (!confirm("Hapus semua data lokal (settings + history)?")) return;
      localStorage.removeItem(STORAGE_KEYS.HISTORY);
      localStorage.removeItem(STORAGE_KEYS.SETTINGS);
      chatHistory = [];
      renderMessages();
      const s = { ...defaultSettings };
      saveSettings(s);
      modelSelect.value = s.model;
      temperatureInput.value = s.temperature;
      tempLabel.textContent = s.temperature.toFixed(1);
      metaTemp.textContent = s.temperature.toFixed(1);
      systemPromptInput.value = s.systemPrompt;
      chipClearStorage.classList.add("active");
      chipModeChat.classList.remove("active");
      chipModeReset.classList.remove("active");
      setTimeout(() => {
        chipModeChat.classList.add("active");
        chipClearStorage.classList.remove("active");
      }, 800);
      showToast("Semua data lokal dihapus.", "success");
    });

    // ======== KIRIM PESAN (puter.ai.chat) ========
    async function sendMessage() {
      if (isSending) return;

      const content = userInput.value.trim();
      if (!content) {
        showToast("Pesan kosong.", "error");
        return;
      }

      const settings = loadSettings();
      const model = settings.model;
      const temperature = settings.temperature;
      const systemText = (settings.systemPrompt || "").trim();

      addMessage("user", content);
      userInput.value = "";
      setSendingState(true);

      try {
        const messagesPayload = [];
        if (systemText) {
          messagesPayload.push({ role: "system", content: systemText });
        }
        chatHistory.forEach(m => {
          messagesPayload.push({ role: m.role, content: m.content });
        });

        const response = await puter.ai.chat(messagesPayload, {
          model,
          temperature
        });

        let answerText = "";

        if (typeof response === "string") {
          answerText = response;
        } else if (response && response.message) {
          const msg = response.message;
          if (Array.isArray(msg.content)) {
            answerText = msg.content
              .map(part => {
                if (typeof part === "string") return part;
                if (part && typeof part.text === "string") return part.text;
                return "";
              })
              .join("")
              .trim();
          } else if (typeof msg.content === "string") {
            answerText = msg.content;
          }
        }

        if (!answerText) {
          answerText = JSON.stringify(response, null, 2);
        }

        addMessage("assistant", answerText);
        showToast("Jawaban diterima.", "success");
      } catch (err) {
        console.error(err);
        showToast(err.message || "Gagal memanggil Puter.ai. Coba lagi.", "error");
      } finally {
        setSendingState(false);
      }
    }

    sendBtn.addEventListener("click", sendMessage);

    userInput.addEventListener("keydown", (e) => {
      if (e.key === "Enter" && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
      }
    });
  </script>
</body>
</html>
